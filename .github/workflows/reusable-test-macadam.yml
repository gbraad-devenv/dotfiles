name: Test bootc images using macadam/machine

on:
  workflow_call:
    inputs:
      prefix_name:
        description: "Name of the image to run with machine and macadam (e.g., dotfedora)"
        required: false
        type: string
        default: "dotfedora"
      image_username:
        description: "Username for log in to the image"
        required: false
        type: string
        default: "gbraad"
      runs-on:
        description: "Target runner"
        required: true
        type: string
        default: "ubuntu-latest"
      arch:
        description: "Target architecture (e.g., arm64, amd64)"
        required: false
        type: string
        default: "amd64"

jobs:
  test-macadam:
    runs-on: ${{ inputs.runs-on }}${{ inputs.arch == 'arm64' && '-arm' || '' }}

    steps:
      - name: Enable linger and create user session (workaround)
        uses: gbraad-actions/blacksmith-user-session@main

      - name: Allow unprivileged userns (workaround)
        uses: gbraad-actions/warpbuild-unprivileged-userns@main

      - name: Get last 3 chars of hostname
        id: runner_id
        run: |
          echo "last3=${HOSTNAME: -3}" >> $GITHUB_OUTPUT

      - name: Remove unwanted stuff
        uses: gbraad-devenv/remove-unwanted@v1

      - name: Tailscale setup (host)
        uses: gbraad-actions/tailscale-action@v1
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          args: --ssh --accept-dns=false --operator=runner --advertise-exit-node
          hostname: "machine-${{ inputs.arch }}-${{ steps.runner_id.outputs.last3 }}"

      - name: Create and share userdirs
        run: |
          cd ${{ github.workspace }}
          mkdir -p Projects Documents Downloads
          ln -s ${{ github.workspace }}/Projects  ${HOME}/Projects
          ln -s ${{ github.workspace }}/Documents ${HOME}/Documents
          ln -s ${{ github.workspace }}/Downloads ${HOME}/Downloads
          tailscale drive share projects ${HOME}/Projects
          tailscale drive share documents ${HOME}/Documents
          tailscale drive share downloads ${HOME}/Downloads
          
      - name: Dotfiles (install from action)
        uses: gbraad-dotfiles/install-action@main
        with:
          upstream: true

      - name: Install required virtualization software
        continue-on-error: true
        uses: gbraad-actions/setup-virtualization@main

      - name: Install containers tools (optional)
        continue-on-error: true
        uses: gbraad-actions/setup-container-tools@v1

      - name: Compile macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            # prepare
            apps projects/gvproxy source checkout
            apps projects/macadam source checkout
            devenv gofedora noinit

            # gvproxy
            apps projects/gvproxy make
            apps projects/gvproxy cp
            
            # macadam
            apps projects/macadam make
            apps projects/macadam cp
          
      - name: Write machinekey
        uses: gbraad-dotfiles/machinekey-action@main

      - name: Prepare images for use with macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            # prepare
            mkdir -p ~/DiskImages
            machine ${{ inputs.prefix_name }} download
      
      - name: Init image with macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            machine ${{ inputs.prefix_name }} create

      - name: Start VM with macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            macadam list
            machine ${{ inputs.prefix_name }} start

      - name: Run test command with macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            machine ${{ inputs.prefix_name }} exec cat /etc/os-release

      - name: Bootc switch VM to golang image
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            machine ${{ inputs.prefix_name }} exec sudo bootc status
            # Note: macadam ssh does not source the profile
            machine ${{ inputs.prefix_name }} exec dotfiles machine golang switch

      - name: Restart VM using macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            macadam list
            machine ${{ inputs.prefix_name }} stop
            machine ${{ inputs.prefix_name }} start
            macadam list

      - name: Run golang with macadam
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            machine ${{ inputs.prefix_name }} exec sudo bootc status
            machine ${{ inputs.prefix_name }} exec go version

      - name: Compile macadam inside the VM
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            # checkout source
            machine ${{ inputs.prefix_name }} exec dotfiles apps projects/gvproxy source checkout
            machine ${{ inputs.prefix_name }} exec dotfiles apps projects/macadam source checkout
            
            # this is a temporary solution as ssh does not pass arguments correctly
            machine ${{ inputs.prefix_name }} exec dotfiles apps projects/gvproxy make local
            machine ${{ inputs.prefix_name }} exec dotfiles apps projects/macadam make local

      - name: Hang around
        if: ${{ failure() }}
        run: |
          sleep 18000
