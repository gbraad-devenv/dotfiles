name: reusable-build-diskimage-packer

on:
  workflow_call:
    inputs:
      container_name:
        required: true
        type: string

jobs:
  packer-machinefile:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Dotfiles (install from action)
        uses: gbraad-dotfiles/install-action@main
        with:
          upstream: true

      - name: Install required virtualization software
        continue-on-error: true
        uses: gbraad-actions/setup-virtualization@v2

      - name: Install containers tools (optional)
        continue-on-error: true
        uses: gbraad-actions/setup-container-tools@v1

      - name: Install packer
        uses: gbraad-actions/install-packer@v1

      - name: Install machinefile
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            app machinefile install

      # as_user starts a new process/session; ensures this runs accelerated
      - name: Run packer init and build process
        uses: gbraad-actions/zsh-action@main
        with:
          as_user: runner
          run: |
            packer init  .packer/${{ inputs.container_name }}/machine.pkr.hcl
            packer build .packer/${{ inputs.container_name }}/machine.pkr.hcl

      - name: Create and push disk image
        run: |
          TAG=$(date +'%y%m%d')

          podman build -t ghcr.io/gbraad-dotfiles/${{ inputs.container_name }}-disk:latest -f .packer/${{ inputs.container_name }}/Containerfile-disk .
          podman tag ghcr.io/gbraad-dotfiles/${{ inputs.container_name }}-disk:latest ghcr.io/gbraad-dotfiles/${{ inputs.container_name }}-disk:${TAG}

          podman login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}

          podman push ghcr.io/gbraad-dotfiles/${{ inputs.container_name }}-disk:latest
          podman push ghcr.io/gbraad-dotfiles/${{ inputs.container_name }}-disk:${TAG}
